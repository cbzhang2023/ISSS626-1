---
title: "Take-home EX01"
author: "Zhang Chenbin"
execute: 
  eval: true
  echo: true
  warning: false
  freeze: true
format: 
  html:
    code-fold: true
runtime: shiny
---

```{r}
pacman::p_load(sf, spNetwork, tmap, tidyverse, spatstat, lubridate, shiny, leaflet, leaflet.extras2, dplyr)
```

```{r}
#| eval: false
car_acc <- read.csv('data/thai_road_accident_2019_2022.csv') %>%
  # Remove rows with missing longitude or latitude
  filter(!is.na(longitude) & !is.na(latitude)) %>%
  
  # Create new columns for month and day of the week
  mutate(Month_num = month(incident_datetime)) %>%
  mutate(Month_fac = month(incident_datetime, label = TRUE, abbr = TRUE)) %>%
  mutate(dayofweek = day(incident_datetime)) %>%
  
  # Convert the data frame to a spatial sf object
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
  
  # Transform to a different CRS (Coordinate Reference System)
  st_transform(crs = 32647)
```

```{r}
#| eval: false
write_rds(car_acc,"data/acc.rds")

```

```{r}
#| eval: false
acc <- read_rds("data/acc.rds")
```

```{r}
#| eval: false
roads <- st_read(dsn="data", 
                   layer="hotosm_tha_roads_lines_shp")
```

```{r}
#| eval: false
adm1 <- st_read(dsn="data", 
                   layer="tha_admbnda_adm1_rtsd_20220121")
```

```{r}
#| eval: false
adm2 <- st_read(dsn="data", 
                   layer="tha_admbnda_adm2_rtsd_20220121")
```

```{r}
#| eval: false
adm3 <- st_read(dsn="data", 
                   layer="tha_admbnda_adm3_rtsd_20220121")
```

```{r}
#| eval: false
# 筛选曼谷省的边界（adm1 - 省级边界）
bangkok_province <- adm1 %>%
  filter(ADM1_EN == "Bangkok")  # 假设 ADM1_EN 是省名字段

# 筛选曼谷市的边界（adm2 - 市级边界）
bangkok_city <- adm2 %>%
  filter(ADM1_EN == "Bangkok")  # 假设市级边界仍然是 "Bangkok"

# 筛选曼谷区的边界（adm3 - 区级边界）
bangkok_district <- adm3 %>%
  filter(ADM1_EN == "Bangkok")  # 假设区级边界字段仍为 "Bangkok"



```

```{r}
#| eval: false

# 如果两个 CRS 不同，将其中一个转换为与另一个相同的 CRS
# 例如，如果需要将 bangkok_province 转换为与 car_acc 相同的 CRS
bangkok_province <- st_transform(bangkok_province, crs = st_crs(car_acc))

# 进行空间相交操作
car_acc_bangkok <- st_intersection(car_acc, bangkok_province)


```

```{r}
#| eval: false
# 确保所有筛选后的数据（bangkok_province, bangkok_city, bangkok_district）的 CRS 与 car_acc_bangkok 一致
bangkok_province <- st_transform(bangkok_province, crs = st_crs(car_acc_bangkok))
bangkok_city <- st_transform(bangkok_city, crs = st_crs(car_acc_bangkok))
bangkok_district <- st_transform(bangkok_district, crs = st_crs(car_acc_bangkok))

# 先将省级（bangkok_province）的信息合并到曼谷的交通事故数据中
car_acc_bangkok_adm1 <- st_join(car_acc_bangkok, bangkok_province)

# 再将市级（bangkok_city）的信息合并到已包含省级数据的事故数据中
car_acc_bangkok_adm1_adm2 <- st_join(car_acc_bangkok_adm1, bangkok_city)

# 最后将区级（bangkok_district）的信息合并到已包含省、市级数据的事故数据中
car_acc_bangkok_full <- st_join(car_acc_bangkok_adm1_adm2, bangkok_district)
```

```{r}
#| eval: false
# 保存为 .rds 文件
saveRDS(bangkok_province, "data/bangkok_province.rds")
saveRDS(bangkok_city, "data/bangkok_city.rds")
saveRDS(bangkok_district, "data/bangkok_district.rds")

```

```{r}
bangkok_province <- st_read("data/bangkok_province.gpkg")
bangkok_city <- st_read("data/bangkok_city.gpkg")
bangkok_district <- st_read("data/bangkok_district.gpkg")
```




```{r}
#| eval: false
library(dplyr)
library(sf)

# 转换 sf 对象为 data.frame 进行字段连接
car_acc_bangkok_full_df <- as.data.frame(car_acc_bangkok_full)
roads_df <- as.data.frame(roads)

# 使用 dplyr 的 left_join 根据 route 和 name_th 进行连接
acc_roads_joined_df <- car_acc_bangkok_full_df %>%
    left_join(roads_df, by = c("route" = "name_th"))

# 保留 geometry.x 列，删除 geometry.y 列
acc_roads_joined_df$geometry <- acc_roads_joined_df$geometry.x

# 删除不需要的列，包括 geometry.y
acc_roads_joined_df_cleaned <- acc_roads_joined_df %>%
    select(-geometry.x, -geometry.y, -ADM2_EN.x, -ADM2_TH.x, -ADM2_PCODE.x, -ADM2_REF, 
           -ADM2ALT1EN, -ADM2ALT2EN, -ADM2ALT1TH, -ADM2ALT2TH, -ADM1_EN.x.1, -ADM1_TH.x.1, 
           -ADM1_PCODE.x.1, -ADM0_EN.x.1, -ADM0_TH.x.1, -ADM0_PCODE.x.1, -ADM2_EN.y, 
           -ADM2_TH.y, -ADM2_PCODE.y, -ADM1_EN.y.1, -ADM1_TH.y.1, -ADM1_PCODE.y.1, 
           -ADM0_EN.y.1, -ADM0_TH.y.1, -ADM0_PCODE.y.1, -date.x.1, -validOn.x.1, 
           -date.y.1, -validOn.y.1, -validTo.y.1)

# 将清理后的数据转换回 sf 对象
acc_roads_joined <- st_as_sf(acc_roads_joined_df_cleaned, sf_column_name = "geometry")

```

```{r}
#| eval: false
# 写入本地文件，例如写成 GeoPackage 格式
# 保存为 .rds 格式
saveRDS(acc_roads_joined, "data/acc_roads_joined_1.rds")


```

```{r}
# 重新从本地读取
# 使用 GeoPackage 格式保存
# 读取 .rds 文件
acc_roads_joined <- readRDS("data/acc_roads_joined_1.rds")
```

111

```{r}
library(dplyr)
library(lubridate)

# 假设你的数据现在叫做 acc_roads_joined
acc_roads_joined <- acc_roads_joined %>%
  mutate(year = year(incident_datetime))  # 从 incident_datetime 提取年份

# 分别提取 2019 到 2022 年的数据
acc_2019 <- filter(acc_roads_joined, year == 2019)
acc_2020 <- filter(acc_roads_joined, year == 2020)
acc_2021 <- filter(acc_roads_joined, year == 2021)
acc_2022 <- filter(acc_roads_joined, year == 2022)

tmap_mode("view")

library(tmap)
library(leaflet)
library(leafsync)

# 使用 tmap 生成多个单独的 leaflet 地图
map_2019 <- tm_shape(bangkok_district) +
  tm_borders(col = "gray", lwd = 2) +
  tm_shape(acc_2019) +
  tm_dots(alpha = 0.6, size = 0.05, col = "black") +
  tm_layout(title = "曼谷交通事故分布 2019", title.size = 1.5)

map_2020 <- tm_shape(bangkok_district) +
  tm_borders(col = "gray", lwd = 2) +
  tm_shape(acc_2020) +
  tm_dots(alpha = 0.6, size = 0.05, col = "black") +
  tm_layout(title = "曼谷交通事故分布 2020", title.size = 1.5)

map_2021 <- tm_shape(bangkok_district) +
  tm_borders(col = "gray", lwd = 2) +
  tm_shape(acc_2021) +
  tm_dots(alpha = 0.6, size = 0.05, col = "black") +
  tm_layout(title = "曼谷交通事故分布 2021", title.size = 1.5)

map_2022 <- tm_shape(bangkok_district) +
  tm_borders(col = "gray", lwd = 2) +
  tm_shape(acc_2022) +
  tm_dots(alpha = 0.6, size = 0.05, col = "black") +
  tm_layout(title = "曼谷交通事故分布 2022", title.size = 1.5)

# 将 tmap 转换为 leaflet
leaflet_2019 <- tmap_leaflet(map_2019)
leaflet_2020 <- tmap_leaflet(map_2020)
leaflet_2021 <- tmap_leaflet(map_2021)
leaflet_2022 <- tmap_leaflet(map_2022)

# 使用 leafsync 将四个地图同步
sync(leaflet_2019, leaflet_2020, leaflet_2021, leaflet_2022)


```

```{r}
# 加载必要的库
library(dplyr)
library(lubridate)
library(tmap)
library(leaflet)
library(sf)

# 假设 acc_roads_joined 和 bangkok_district 使用的是 EPSG:32647
# 将它们转换为 EPSG:4326
acc_roads_joined <- st_transform(acc_roads_joined, crs = 4326)
bangkok_district <- st_transform(bangkok_district, crs = 4326)

# 创建一个交互选择框的调色板
pal <- colorFactor(palette = "Set1", domain = acc_roads_joined$presumed_cause)

# 创建地图并使用 leaflet 实现交互式选择框
leaflet_map <- leaflet() %>%
  addTiles() %>%
  addPolygons(data = bangkok_district, color = "gray", weight = 2) %>%
  addCircleMarkers(data = acc_roads_joined, 
                   color = ~pal(presumed_cause), 
                   popup = ~presumed_cause, 
                   group = ~presumed_cause) %>%
  addLayersControl(
    overlayGroups = unique(acc_roads_joined$presumed_cause),
    options = layersControlOptions(collapsed = FALSE)
  )

# 显示地图
leaflet_map

```

```{r}


```
